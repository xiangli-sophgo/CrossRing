# 反方向流控设计文档

本文档描述CrossRing NoC系统中基于队列深度的反方向流控机制设计。

---

## 设计目标

当正常方向的FIFO队列拥塞时，将flit转发到反方向绕环，实现负载均衡。

---

## 策略逻辑

### 核心思想

- 比较正常方向和反方向的FIFO队列深度
- 只有当反方向队列深度**显著低于**正常方向时，才允许转向
- 判断标准：`反方向深度 < 正常方向深度 × 阈值比例`

### 横向流控（IQ仲裁阶段）

- **判断位置**：IQ仲裁时的方向选择
- **比较对象**：IQ_OUT队列深度（TL vs TR）
- **触发条件**：
  - flit正常应该去TR，但TL队列深度 < TR队列深度 × 阈值 → 允许放入TL
  - flit正常应该去TL，但TR队列深度 < TL队列深度 × 阈值 → 允许放入TR

### 纵向流控（RB仲裁阶段）

- **判断位置**：RB仲裁时的方向选择
- **比较对象**：RB_OUT队列深度（TU vs TD）
- **触发条件**：
  - flit正常应该去TU，但TD队列深度 < TU队列深度 × 阈值 → 允许转发到TD
  - flit正常应该去TD，但TU队列深度 < TD队列深度 × 阈值 → 允许转发到TU

---

## 配置参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `REVERSE_DIRECTION_FLOW_CONTROL_ENABLED` | 是否启用反方向流控 | 0 (关闭) |
| `REVERSE_DIRECTION_THRESHOLD` | 反方向队列深度必须低于正常方向的比例 | 0.5 |

---

## 硬件RTL实现分析

### 硬件友好性

1. **逻辑简单** - 只需比较两个FIFO深度计数器，一个乘法/移位，一个比较
2. **局部信息** - 只需要当前节点的队列深度，不需要跨节点通信
3. **单周期完成** - 判断逻辑为纯组合逻辑

### 硬件实现伪代码

```verilog
// 反方向流控判断逻辑
wire [WIDTH-1:0] normal_depth = fifo_normal.count;
wire [WIDTH-1:0] reverse_depth = fifo_reverse.count;
wire [WIDTH-1:0] threshold_value = normal_depth >> 1;  // 0.5倍 = 右移1位

wire allow_reverse = (normal_depth > 0) && (reverse_depth < threshold_value);
```

### 阈值选择建议

| 阈值 | 硬件实现 | 开销 |
|------|---------|------|
| 0.5 | 右移1位 | 0门 |
| 0.25 | 右移2位 | 0门 |
| 0.75 | 右移1位 + 右移2位 | ~10门 |

- 推荐使用2的幂次分数，可用移位代替乘法，零硬件成本
- 避免复杂小数（如0.3），需要定点乘法器

### 硬件开销估算

| 组件 | 门数 | 说明 |
|------|------|------|
| 队列深度计数器（已有） | 0 | 复用现有FIFO控制器 |
| 移位器 | 0 | 硬连线实现 |
| 比较器 | ~15门 | 2个比较（>0 和 <阈值） |
| 逻辑门 | ~5门 | AND/OR组合 |
| **每个方向总计** | **~20门** | |

以5×4拓扑为例：
- 20节点 × 4方向 × 20门 = **~1600门**
- 开销极低，完全可接受

### 时序考虑

- 判断在仲裁关键路径上，可能增加少量延迟
- 队列深度计数器位宽较小（通常4-6位），比较器延迟可忽略

---

## 设计优势

1. **负载均衡** - 拥塞时利用反方向绕环，分散流量
2. **硬件友好** - 仅使用本地信息，无跨节点通信
3. **零额外存储** - 复用现有队列深度计数器
4. **可配置** - 阈值可调，适应不同场景
5. **保守策略** - 只有反方向显著空闲时才转向，避免不必要的绕路

---

## 与其他流控机制的关系

| 机制 | 层级 | 作用 | 与本方案关系 |
|------|------|------|-------------|
| Token Bucket | IP层 | 带宽限制 | 独立，可同时启用 |
| E-Tag | CrossPoint | 下环优先级 | 独立 |
| I-Tag | CrossPoint | 上环预约 | 独立 |
| FIFO深度 | Network | 缓冲管理 | **数据源**，复用队列深度 |
| Tracker | IP层 | 事务并发控制 | 独立 |

---

## 潜在风险与缓解

### 活锁风险

**风险**：flit可能在两个方向之间震荡

**缓解**：
- 阈值设置较低（0.5），只有反方向显著空闲时才转向
- 转向后路径会自动更新（绕环），不会再次判断转向

### 延迟增加

**风险**：反方向绕环增加传输延迟

**缓解**：
- 只在正常方向拥塞时才使用，拥塞情况下绕环反而可能更快
- 通过阈值控制，避免不必要的绕路

---

**文档版本**: v1.0
**最后更新**: 2025-11-30
**状态**: 已实现
