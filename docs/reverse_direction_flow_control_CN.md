# 反方向流控设计文档

本文档描述CrossRing NoC系统中基于队列深度的反方向流控机制设计。

---

## 设计目标

当正常方向上环困难（队列接近满）时，允许flit从反方向上环，作为备选通道让flit更容易上环。

---

## 策略逻辑

### 核心思想

- 比较正常方向和反方向的FIFO队列深度差异
- 只有当正常方向比反方向**拥塞程度超过一定阈值**时，才允许走反方向
- 判断标准：`(正常方向深度 - 反方向深度) > 容量 × 阈值比例`
- 如果反方向也很满，则不走反方向

### 横向流控（IQ仲裁阶段）

- **判断位置**：IQ仲裁时的方向选择
- **比较对象**：IQ_OUT队列深度（TL/TR）
- **容量参数**：`IQ_OUT_FIFO_DEPTH_HORIZONTAL`
- **触发条件**：
  - flit正常应该去TR，但 (TR深度 - TL深度) > 容量 × 阈值 → 允许放入TL
  - flit正常应该去TL，但 (TL深度 - TR深度) > 容量 × 阈值 → 允许放入TR

### 纵向流控（RB仲裁阶段）

- **判断位置**：RB仲裁时的方向选择
- **比较对象**：RB_OUT队列深度（TU/TD）
- **容量参数**：`RB_OUT_FIFO_DEPTH`
- **触发条件**：
  - flit正常应该去TU，但 (TU深度 - TD深度) > 容量 × 阈值 → 允许转发到TD
  - flit正常应该去TD，但 (TD深度 - TU深度) > 容量 × 阈值 → 允许转发到TU

---

## 配置参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `REVERSE_DIRECTION_ENABLED` | 是否启用反方向流控 | 0 (关闭) |
| `REVERSE_DIRECTION_THRESHOLD` | 正常方向比反方向拥塞程度超过容量的多少比例时才走反方向 | 0.5 |

**示例**（容量=8，阈值=0.5）：
- TR=6, TL=0 → (6-0)=6 > 8×0.5=4 ✅ 允许走TL
- TR=6, TL=4 → (6-4)=2 > 4 ❌ 不允许走TL（反方向也很满）
- TR=7, TL=2 → (7-2)=5 > 4 ✅ 允许走TL

---

## 硬件RTL实现分析

### 硬件友好性

1. **逻辑简单** - 只需比较两个FIFO深度计数器的差值与容量阈值
2. **局部信息** - 只需要当前节点的队列深度和容量，不需要跨节点通信
3. **单周期完成** - 判断逻辑为纯组合逻辑

### 硬件实现伪代码

```verilog
// 反方向流控判断逻辑
wire [WIDTH-1:0] normal_depth = fifo_normal.count;
wire [WIDTH-1:0] reverse_depth = fifo_reverse.count;
wire [WIDTH-1:0] capacity = FIFO_DEPTH;  // FIFO容量（编译时常量）
wire [WIDTH-1:0] threshold_value = capacity >> 1;  // 0.5倍 = 右移1位
wire [WIDTH:0] depth_diff = normal_depth - reverse_depth;  // 有符号差值

wire allow_reverse = (depth_diff > threshold_value);
```

### 阈值选择建议

| 阈值 | 含义 | 硬件实现 | 开销 |
|------|------|---------|------|
| 0.25 | 差值超过25%容量时走反方向 | capacity >> 2 | 0门 |
| 0.5 | 差值超过50%容量时走反方向 | capacity >> 1 | 0门 |
| 0.75 | 差值超过75%容量时走反方向 | (capacity >> 1) + (capacity >> 2) | ~10门 |

- 推荐使用2的幂次分数，可用移位代替乘法，低硬件成本
- 容量为编译时常量，阈值计算可预先完成

### 硬件开销估算

| 组件 | 门数 | 说明 |
|------|------|------|
| 队列深度计数器（已有） | 0 | 复用现有FIFO控制器 |
| 减法器 | ~15门 | 计算深度差值 |
| 阈值计算（编译时常量） | 0 | 预计算 |
| 比较器 | ~10门 | 1个比较（> 阈值） |
| 逻辑门 | ~5门 | AND/OR组合 |
| **每个方向总计** | **~30门** | |

以5×4拓扑为例：
- 20节点 × 4方向 × 30门 = **~2400门**
- 开销较低，完全可接受

### 时序考虑

- 判断在仲裁关键路径上，可能增加少量延迟
- 队列深度计数器位宽较小（通常4-6位），比较器延迟可忽略

---

## 设计优势

1. **提升上环成功率** - 正常方向拥塞时，反方向作为备选通道
2. **智能决策** - 同时考虑正常方向和反方向的拥塞程度，避免盲目转向
3. **硬件友好** - 仅使用本地信息，无跨节点通信
4. **零额外存储** - 复用现有队列深度计数器
5. **可配置** - 阈值可调，适应不同场景
6. **保守策略** - 只有正常方向比反方向拥塞很多时才走反方向，避免不必要的绕路

---

## 与其他流控机制的关系

| 机制 | 层级 | 作用 | 与本方案关系 |
|------|------|------|-------------|
| Token Bucket | IP层 | 带宽限制 | 独立，可同时启用 |
| E-Tag | CrossPoint | 下环优先级 | 独立 |
| I-Tag | CrossPoint | 上环预约 | 独立 |
| FIFO深度 | Network | 缓冲管理 | **数据源**，复用队列深度 |
| Tracker | IP层 | 事务并发控制 | 独立 |

---

## 潜在风险与缓解

### 活锁风险

**风险**：flit可能在两个方向之间震荡

**缓解**：
- 判断基于差值，只有正常方向比反方向拥塞很多时才走反方向
- 如果反方向也很满，不会走反方向
- 转向后路径会自动更新（绕环），不会再次判断转向

### 延迟增加

**风险**：反方向绕环增加传输延迟

**缓解**：
- 只在正常方向比反方向拥塞很多时才使用
- 如果两个方向都拥塞，不会盲目选择反方向
- 通过阈值控制，避免不必要的绕路

---

**文档版本**: v3.0
**最后更新**: 2025-12-01
**状态**: 已实现
