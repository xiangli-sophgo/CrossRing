# 结果数据展示优化计划

## 需求概述

优化结果数据的展示，将数据明确分为三组：配置参数、结果统计、结果文件，使用折叠面板展示。

## 数据分组定义

### 1. 配置参数（仿真输入）

来自 `config_params` 中的配置项：

- **基本参数**: TOPO_TYPE, FLIT_SIZE, BURST, NETWORK_FREQUENCY, SLICE_PER_LINK_*
- **FIFO深度**: IQ_CH_FIFO_DEPTH, EQ_CH_FIFO_DEPTH, IQ_OUT_FIFO_DEPTH_*, RB_*_FIFO_DEPTH, EQ_IN_FIFO_DEPTH, IP_*_FIFO_DEPTH
- **延迟配置**: DDR_R_LATENCY_original, DDR_W_LATENCY_original, L2M_*_LATENCY_original, SN_TRACKER_RELEASE_LATENCY_original
- **资源配置**: RN_RDB_SIZE, RN_WDB_SIZE, SN_DDR_*_SIZE, SN_L2M_*_SIZE, UNIFIED_RW_TRACKER
- **ETag配置**: TL_Etag_*, TR_Etag_*, TU_Etag_*, TD_Etag_*, ETag_BOTHSIDE_UPGRADE
- **ITag配置**: ITag_TRIGGER_Th_*, ITag_MAX_NUM_*
- **带宽限制**: *_BW_LIMIT
- **功能开关**: ENABLE_*, ORDERING_*, CROSSRING_VERSION

### 2. 结果统计（仿真输出）

来自 `result_details` 或 `config_params` 中以 `_stat` 结尾或中文命名的结果：

- **带宽统计**: 带宽_*, 平均带宽_*, 总和带宽
- **延迟统计**: 命令延迟_*, 数据延迟_*, 事务延迟_*
- **完成时间**: 读完成时间, 写完成时间, 总完成时间
- **网络行为**: 绕环_*, 保序阻止_*, 请求*环次数, 响应*环次数, 数据*环次数
- **等待周期**: 请求*等待周期, 响应*等待周期, 数据*等待周期
- **Retry统计**: 读重试次数, 写重试次数
- **Tag统计**: *_ETag_*, ITag_*

### 3. 结果文件

需要新增数据库字段存储：

- **HTML报告** (result_html): 存储完整HTML内容，点击在新窗口渲染
- **CSV文件路径** (result_files): JSON数组存储文件路径列表，点击打开本地文件

## 实现方案

### 一、数据库修改

#### 1.1 修改 Result 模型 (`src/database/models.py`)

```python
# 在 KcinResult 和 DcinResult 中新增字段：
result_html = Column(Text)  # HTML报告内容
result_files = Column(Text)  # 结果文件路径列表 (JSON数组)
```

#### 1.2 修改 DatabaseManager (`src/database/database.py`)

- `add_result()` 方法增加 result_html 和 result_files 参数
- `_result_to_dict()` 方法返回新字段

#### 1.3 修改 ResultManager (`src/database/manager.py`)

- `add_result()` 方法支持新参数

### 二、仿真保存修改

#### 2.1 修改 save_to_database (`src/noc/mixins/stats_mixin.py`)

在保存结果时：

1. 读取生成的 `result_analysis.html` 文件内容
2. 收集所有生成的CSV文件路径
3. 将 HTML 内容和文件路径列表传递给数据库

### 三、后端API修改

#### 3.1 修改结果响应模型 (`result_db_web/backend/app/api/results.py`)

```python
class ResultResponse(BaseModel):
    # ... 现有字段 ...
    result_html: Optional[str] = None
    result_files: Optional[List[str]] = None
```

#### 3.2 新增HTML预览端点

```python
@router.get("/results/{result_id}/html")
async def get_result_html(result_id: int):
    """获取结果HTML报告内容"""
```

#### 3.3 新增文件打开端点

```python
@router.post("/open-file")
async def open_local_file(path: str):
    """打开本地文件（调用系统默认程序）"""
```

### 四、前端修改

#### 4.1 修改类型定义 (`result_db_web/frontend/src/types/index.ts`)

```typescript
export interface SimulationResult {
  // ... 现有字段 ...
  result_html?: string;
  result_files?: string[];
}
```

#### 4.2 新增参数分类工具 (`result_db_web/frontend/src/utils/paramClassifier.ts`)

```typescript
// 配置参数关键词
const CONFIG_PARAM_PATTERNS = [
  /^TOPO_TYPE$/, /^FLIT_SIZE$/, /^BURST$/, /FREQUENCY/,
  /FIFO_DEPTH/, /LATENCY/, /_SIZE$/, /Etag/, /ITag/,
  /BW_LIMIT/, /^ENABLE_/, /^ORDERING_/, /CROSSRING_VERSION/,
  /SLICE_PER_LINK/, /_RW_GAP$/, /IN_ORDER_/
];

// 结果统计关键词
const RESULT_STAT_PATTERNS = [
  /^带宽/, /^平均带宽/, /^总和带宽/,
  /延迟/, /完成时间/, /^绕环/, /^保序阻止/,
  /环次数/, /等待周期/, /重试次数/,
  /ETag.*num/, /ITag.*num/
];

export function classifyParams(params: Record<string, any>): {
  configParams: Record<string, any>;
  resultStats: Record<string, any>;
}
```

#### 4.3 修改 ResultTable 组件 (`result_db_web/frontend/src/components/ResultTable.tsx`)

使用 Collapse 折叠面板替代单一表格：

```tsx
<Collapse defaultActiveKey={['config']}>
  <Panel header="配置参数" key="config">
    <Descriptions column={3} size="small">
      {/* 配置参数列表 */}
    </Descriptions>
  </Panel>
  <Panel header="结果统计" key="stats">
    <Descriptions column={3} size="small">
      {/* 结果统计列表 */}
    </Descriptions>
  </Panel>
  <Panel header="结果文件" key="files">
    <Space direction="vertical">
      <Button onClick={viewHtmlReport}>查看HTML报告</Button>
      <List dataSource={result_files} renderItem={...} />
    </Space>
  </Panel>
</Collapse>
```

### 五、文件清单

#### 需要修改的文件：

1. `src/database/models.py` - 新增字段
2. `src/database/database.py` - 修改CRUD方法
3. `src/database/manager.py` - 修改业务方法
4. `src/noc/mixins/stats_mixin.py` - 保存HTML和文件路径
5. `result_db_web/backend/app/api/results.py` - 新增API端点
6. `result_db_web/frontend/src/types/index.ts` - 类型定义
7. `result_db_web/frontend/src/components/ResultTable.tsx` - 折叠面板展示

#### 需要新增的文件：

1. `result_db_web/frontend/src/utils/paramClassifier.ts` - 参数分类工具

### 六、实现顺序

1. 数据库模型修改和迁移
2. 后端API修改
3. 仿真保存逻辑修改
4. 前端参数分类工具
5. 前端折叠面板展示
6. 测试验证
