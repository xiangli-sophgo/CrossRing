# Tier6+ 互联建模系统 - 功能现状分析

> 分析日期: 2025-12-25
> 当前版本: v1.7.4

## 一、系统概述

Tier6+是一个层级拓扑可视化与LLM部署分析系统，支持从数据中心到芯片的5层架构建模，提供3D和2D两种视图模式，并集成了LLM并行部署方案的自动分析与优化功能。

### 技术栈
- **前端**: React + TypeScript + Three.js (React Three Fiber) + Ant Design + Cytoscape.js
- **后端**: Python + FastAPI + Pydantic

---

## 二、已实现功能清单

### 1. 3D可视化 (Scene3D.tsx)

| 功能 | 状态 | 说明 |
|------|------|------|
| 统一场景渲染 | ✅ | 所有层级内容一次性渲染，通过相机移动切换 |
| 平滑相机动画 | ✅ | easeInOutCubic缓动，1.5秒过渡 |
| 透明度过渡 | ✅ | 淡入0.8秒，淡出0.2秒 |
| 拟物化3D模型 | ✅ | Chip/Board/Rack/Pod四种模型 |
| 双击下钻 | ✅ | 点击进入下一层级 |
| 面包屑导航 | ✅ | 显示路径，支持跳转 |
| OrbitControls | ✅ | 旋转/缩放/平移 |

### 2. 2D拓扑图 (TopologyGraph.tsx)

| 功能 | 状态 | 说明 |
|------|------|------|
| 多层级视图 | ✅ | Datacenter/Pod/Rack/Board/Chip |
| 智能布局算法 | ✅ | 分层/圆形/环形/Torus/FullMesh |
| 节点样式 | ✅ | Switch/Pod/Rack/Board/Chip 5种 |
| 连接线渲染 | ✅ | 直线/弧线/曲线 |
| 双击下钻 | ✅ | 与3D视图联动 |

### 3. 拓扑类型支持

| 拓扑类型 | 状态 | 说明 |
|----------|------|------|
| none | ✅ | 无连接 |
| full_mesh | ✅ | 全连接 |
| full_mesh_2d | ✅ | 行列全连接 |
| ring | ✅ | 环形 |
| torus_2d | ✅ | 2D环面 |
| torus_3d | ✅ | 3D环面 |

### 4. Switch配置

| 功能 | 状态 | 说明 |
|------|------|------|
| 四层级配置 | ✅ | datacenter/pod/rack/board |
| 多层Switch | ✅ | leaf-spine-core |
| 同层互联 | ✅ | 可选开关 |
| 连接模式 | ✅ | full_mesh / custom |
| 端口统计 | ✅ | 上行/下行/互联 |

### 5. 手动连接系统

| 功能 | 状态 | 说明 |
|------|------|------|
| 多选模式 | ✅ | Ctrl+点击选择 |
| 连线模式 | ✅ | 点击源→目标 |
| 连接管理 | ✅ | 添加/删除/去重 |
| append/replace模式 | ✅ | 追加或替换自动连接 |

### 6. 配置系统

| 功能 | 状态 | 说明 |
|------|------|------|
| 灵活板卡配置 | ✅ | 自定义名称/U高度/芯片 |
| 配置保存/加载 | ✅ | localStorage + 服务器 |
| 实时预览 | ✅ | 500ms防抖 |

### 7. 后端API

| 接口类型 | 状态 | 说明 |
|----------|------|------|
| 拓扑CRUD | ✅ | 生成/查询/按层级筛选 |
| 配置管理 | ✅ | 保存/加载/删除 |
| 手动连接 | ✅ | 完整CRUD |

---

## 三、当前架构优势

1. **完整的层级体系**: 5层导航，双视图同步
2. **灵活的拓扑配置**: 6种直连拓扑 + 多层Switch
3. **良好的用户体验**: 平滑动画，实时预览
4. **可扩展的数据模型**: Pydantic验证，TypeScript类型安全

---

## 四、当前架构限制

### 4.1 拓扑图显示限制

| 限制 | 影响 | 严重程度 |
|------|------|----------|
| 单层级显示 | 无法看到跨层级连接全貌 | 高 |
| 无虚拟滚动 | >1000节点性能下降 | 中 |
| 无节点聚合 | 节点多时画面混乱 | 高 |
| 无LOD机制 | 缩小时细节过多 | 中 |

### 4.2 连接属性限制

| 限制 | 影响 | 严重程度 |
|------|------|----------|
| 仅支持带宽 | 无法配置延迟、丢包率 | 高 |
| 无流量可视化 | 无法看到实际流量分布 | 高 |
| 无路由显示 | 无法追踪数据路径 | 中 |

### 4.3 分析功能缺失

| 缺失功能 | 影响 | 严重程度 |
|----------|------|----------|
| 拓扑性能指标 | 无法评估拓扑质量 | 高 |
| 故障模拟 | 无法验证冗余设计 | 中 |
| 仿真集成 | 无法直接运行性能仿真 | 中 |

---

## 五、代码结构

```
Tier6+model/
├── frontend/src/
│   ├── components/
│   │   ├── Scene3D.tsx          # 3D场景 (~1300行)
│   │   ├── TopologyGraph.tsx    # 2D拓扑图 (~800行)
│   │   ├── ConfigPanel.tsx      # 配置面板
│   │   ├── SwitchConfig.tsx     # Switch配置
│   │   └── ManualConnections.tsx# 手动连接
│   ├── types/
│   │   └── types.ts             # 类型定义
│   └── App.tsx                  # 主应用
├── backend/
│   ├── main.py                  # FastAPI入口
│   ├── models.py                # Pydantic模型
│   ├── topology.py              # 拓扑生成引擎
│   └── saved_configs/           # 配置存储
```

---

## 六、关键代码位置

| 功能 | 文件 | 行号 |
|------|------|------|
| 相机动画 | Scene3D.tsx | 47-125 |
| 透明度过渡 | Scene3D.tsx | 603-625 |
| 相机目标计算 | Scene3D.tsx | 1224-1302 |
| 节点位置计算 | Scene3D.tsx | 700-763 |
| 拓扑布局算法 | TopologyGraph.tsx | 200-400 |
| 连接生成 | topology.py | 300-500 |

---

## 七、LLM部署分析系统

### 7.1 功能概述

LLM部署分析系统集成在Tier6+中，用于分析大语言模型在不同硬件拓扑和并行策略下的性能表现。

### 7.2 Feature List

#### 7.2.1 模型配置功能

| 功能 | 状态 | 说明 |
|------|------|------|
| 模型预设 | ✅ | LLaMA-7B/13B/70B, LLaMA-3-8B/70B, Mistral-7B 等 |
| 自定义模型参数 | ✅ | hidden_size, num_layers, attention_heads 等 |
| MoE模型支持 | ✅ | num_experts, experts_per_tok, shared_experts |
| 数据精度选择 | ✅ | fp32/fp16/bf16/int8/int4 |
| GQA/MQA支持 | ✅ | 可配置 kv_heads 不等于 attention_heads |

#### 7.2.2 硬件配置功能

| 功能 | 状态 | 说明 |
|------|------|------|
| 芯片预设 | ✅ | H100-SXM, A100-80G, A100-40G 等 |
| 自定义芯片参数 | ✅ | 算力(TFLOPs)、显存(GB)、带宽(GB/s) |
| 节点配置 | ✅ | chips_per_node, 节点内带宽/延迟 |
| 集群配置 | ✅ | num_nodes, 节点间带宽/延迟 |
| 拓扑自动提取 | ✅ | 从拓扑配置自动提取硬件参数 |

#### 7.2.3 并行策略功能

| 功能 | 状态 | 说明 |
|------|------|------|
| 5维并行策略 | ✅ | DP/TP/PP/EP/SP |
| 可行性检查 | ✅ | 整除约束、显存约束、芯片数约束 |
| 候选策略生成 | ✅ | 自动生成2的幂次方候选值 |
| 方案搜索 | ✅ | 遍历所有可行组合 |
| Pareto前沿 | ✅ | 多目标优化筛选 |

#### 7.2.4 性能分析功能

| 功能 | 状态 | 说明 |
|------|------|------|
| 显存分析 | ✅ | 模型权重、KV Cache、激活值、开销 |
| FLOPs计算 | ✅ | Prefill/Decode阶段分别计算 |
| 通信量计算 | ✅ | TP/PP/EP/SP各维度通信量 |
| 延迟估算 | ✅ | TTFT、TPOT、E2E延迟 |
| 吞吐量估算 | ✅ | tokens/s, requests/s |
| MFU计算 | ✅ | 模型算力利用率 |
| 瓶颈识别 | ✅ | compute/memory/communication/bubble |

#### 7.2.5 评分与排序功能

| 功能 | 状态 | 说明 |
|------|------|------|
| 综合评分 | ✅ | 延迟30% + 吞吐35% + 效率20% + 均衡15% |
| 自定义权重 | ✅ | 用户可调整各项权重 |
| Top-K排序 | ✅ | 按综合分排序输出 |
| 优化建议 | ✅ | 自动生成改进建议 |

#### 7.2.6 拓扑融合功能

| 功能 | 状态 | 说明 |
|------|------|------|
| 芯片自动映射 | ✅ | 物理芯片→并行rank映射 |
| 通信组生成 | ✅ | 根据并行策略生成通信组 |
| 流量路由 | ✅ | BFS最短路径 |
| 链路利用率 | ✅ | 计算每条链路流量占比 |
| 瓶颈链路识别 | ✅ | 利用率>80%标记为瓶颈 |

#### 7.2.7 可视化功能

| 功能 | 状态 | 说明 |
|------|------|------|
| 方案对比表格 | ✅ | 多方案并排对比 |
| 性能指标图表 | ✅ | 延迟/吞吐/显存可视化 |
| 流量热力图 | ⚠️ | 基础实现，未与拓扑图联动 |
| 瓶颈高亮 | ⚠️ | 基础实现，可视化效果待优化 |

**图例**: ✅ 已完成 | ⚠️ 部分完成 | ❌ 未实现

### 7.3 并行策略定义

**文件位置**: `frontend/src/utils/llmDeployment/types.ts:140-152`

| 并行类型 | 缩写 | 含义 | 通信模式 |
|----------|------|------|----------|
| 数据并行 | DP | 不同数据副本 | Ring AllReduce |
| 张量并行 | TP | 切分矩阵计算 | Ring AllReduce |
| 流水线并行 | PP | 切分模型层 | P2P 点对点 |
| 专家并行 | EP | MoE专家分布 | All-to-All |
| 序列并行 | SP | 切分序列维度 | AllGather |

**约束条件**:
- `DP × TP × PP × EP ≤ 最大芯片数`
- TP 必须整除 `attention_heads` 和 `kv_heads`
- PP 必须整除 `num_layers`
- EP 必须整除 `num_experts` (MoE模型)

### 7.4 芯片放置策略

**文件位置**: `frontend/src/utils/llmDeployment/chipMapper.ts:101-128`

**优化原则**: TP组优先放同Board/Rack内，PP组可跨Rack，DP组可跨Pod

```typescript
// 排序优先级：Pod → Rack → Board → Chip
// Rank计算顺序（最内层到最外层）：SP → EP → PP → TP → DP
```

**结果**: 相邻 global rank 的芯片物理位置接近，TP组成员在同Board/Rack内。

### 7.5 通信组生成

**文件位置**: `frontend/src/utils/llmDeployment/chipMapper.ts:177-321`

| 并行类型 | 集合操作 | 通信模式 | 实现细节 |
|----------|----------|----------|----------|
| TP | AllReduce | Ring环形 | `members[i] → members[(i+1) % n]` |
| PP | P2P | 相邻传递 | `members[i] → members[i+1]` |
| DP | AllReduce | Ring环形 | 推理时通信量为0 |
| EP | AllToAll | 全连接 | 每对节点间通信 |
| SP | AllGather | Ring环形 | 收集序列分片 |

### 7.6 流量映射算法

**文件位置**: `frontend/src/utils/llmDeployment/trafficMapper.ts:60-94`

**算法**: BFS最短路径

```
1. 根据 topology.connections 构建无向图
2. 对每个通信对，BFS找最短路径
3. 将流量累加到路径上的每条链路
4. 计算链路利用率 = 流量 / (带宽 × 125)
```

**瓶颈判断**: 利用率 > 80% 的链路标记为瓶颈。

### 7.7 延迟计算模型

**文件位置**: `frontend/src/utils/llmDeployment/latencyEstimator.ts`

#### Prefill阶段 (TTFT)

| 组成部分 | 计算公式 |
|----------|----------|
| 计算延迟 | `FLOPs / (芯片算力 × MFU × TP × PP)` |
| 通信延迟 | `max(TP, PP, EP, SP延迟) + 其他 × 0.3` |
| 气泡比 | `(PP-1) / (micro_batches + PP - 1)` |
| **总延迟** | `max(计算, 通信) / (1 - 气泡比)` |

#### Decode阶段 (TPOT)

| 组成部分 | 计算公式 |
|----------|----------|
| 计算延迟 | `单token FLOPs / (芯片算力 × MFU × 并行度)` |
| 访存延迟 | `(模型权重 + KV Cache) / 显存带宽` |
| 通信延迟 | `TP + PP + EP + SP延迟` |
| **总延迟** | `max(计算, 访存) + 通信` |

#### 端到端延迟
```
E2E = TTFT + TPOT × output_seq_length
```

### 7.8 综合评分系统

**文件位置**: `frontend/src/utils/llmDeployment/planAnalyzer.ts:218-256`

| 评分项 | 计算方式 | 默认权重 |
|--------|----------|----------|
| 延迟评分 | TTFT < 100ms 满分，> 1000ms 得0分 | 30% |
| 吞吐评分 | `min(100, MFU × 200)` | 35% |
| 效率评分 | `(计算利用率 + 显存利用率) / 2 × 100` | 20% |
| 均衡评分 | 负载均衡得分 × 100 | 15% |

**综合评分公式**:
```
overall = latency×0.3 + throughput×0.35 + efficiency×0.2 + balance×0.15
```

### 7.9 拓扑连接对部署分析的影响

**文件位置**: `frontend/src/utils/llmDeployment/topologyHardwareExtractor.ts:118-165`

| 连接类型 | 配置字段 | 影响范围 |
|----------|----------|----------|
| Chip间连接 (intra) | `bandwidth`, `latency` | TP/SP通信延迟 |
| Board间连接 (inter) | `bandwidth`, `latency` | PP/EP/DP通信延迟 |

**默认值**:
```typescript
intraNodeBandwidth = 900   // NVLink 4.0 (GB/s)
interNodeBandwidth = 400   // NDR 400G (GB/s)
intraNodeLatency = 1       // 1us
interNodeLatency = 2       // 2us
```

---

## 八、当前缺陷分析

### 8.1 通信模型简化问题

| 缺陷 | 影响 | 严重程度 |
|------|------|----------|
| 固定使用Ring AllReduce | 小消息场景延迟估算不准 | 中 |
| 未考虑NCCL自动优化 | 实际通信可能更高效 | 低 |
| 通信重叠假设固定30% | 不同硬件重叠能力不同 | 中 |

**详情**: 代码中TP/DP固定使用Ring AllReduce，但实际NCCL会根据消息大小选择：
- 小消息 (< 256KB): Tree AllReduce（延迟低）
- 大消息 (> 256KB): Ring AllReduce（带宽高）

### 8.2 流量路径选择问题

| 缺陷 | 影响 | 严重程度 |
|------|------|----------|
| 仅使用BFS最短路径 | 未考虑链路负载均衡 | 高 |
| 无多路径支持 | 高带宽场景利用率低 | 中 |
| 未考虑拓扑特性 | Ring/Torus等拓扑优势未利用 | 中 |

### 8.3 延迟估算精度问题

| 缺陷 | 影响 | 严重程度 |
|------|------|----------|
| MFU使用固定估计值 | Prefill 0.5, Decode 0.3 | 中 |
| 未考虑Kernel启动开销 | 小batch延迟低估 | 低 |
| 未考虑内存层级 | L2 Cache命中率影响 | 低 |

### 8.4 硬件建模不完整

| 缺陷 | 影响 | 严重程度 |
|------|------|----------|
| 未区分NVLink/PCIe/IB | 不同互联类型性能差异大 | 高 |
| 未考虑NVSwitch | DGX系统通信模式不同 | 中 |
| 未考虑RDMA特性 | 跨节点延迟估算不准 | 中 |

### 8.5 拓扑-部署融合不足

| 缺陷 | 影响 | 严重程度 |
|------|------|----------|
| 芯片放置策略简单 | 仅按层级排序，未优化TP组放置 | 高 |
| 未利用拓扑连接信息 | 实际连接带宽未参与放置决策 | 高 |
| 流量热力图未与拓扑联动 | 用户难以直观理解瓶颈 | 中 |

---

## 九、改进建议

### 9.1 短期改进 (1-2周)

| 改进项 | 描述 | 优先级 |
|--------|------|--------|
| 通信算法选择 | 根据消息大小自动选择Ring/Tree | P1 |
| MFU动态估算 | 基于batch_size和seq_length估算MFU | P1 |
| 互联类型区分 | 支持NVLink/PCIe/InfiniBand配置 | P2 |

### 9.2 中期改进 (1个月)

| 改进项 | 描述 | 优先级 |
|--------|------|--------|
| 智能芯片放置 | 基于拓扑连接带宽优化TP组放置 | P1 |
| 多路径路由 | 支持ECMP等负载均衡路由 | P2 |
| 流量热力图增强 | 在2D/3D拓扑图上显示通信流量 | P2 |

### 9.3 长期改进 (3个月)

| 改进项 | 描述 | 优先级 |
|--------|------|--------|
| 仿真集成 | 与CrossRing仿真引擎对接 | P1 |
| 实际性能校准 | 基于实测数据校准估算模型 | P2 |
| 自动拓扑优化 | 根据部署需求推荐最优拓扑 | P3 |

---

## 十、关键代码位置汇总

### 10.1 LLM部署分析模块

| 功能 | 文件 | 关键函数/行号 |
|------|------|---------------|
| 类型定义 | `llmDeployment/types.ts` | 全文件 |
| 芯片映射 | `llmDeployment/chipMapper.ts` | `autoMapChipsToParallelism:137-172` |
| 通信组生成 | `llmDeployment/chipMapper.ts` | `generateCommunicationGroups:177-321` |
| 流量映射 | `llmDeployment/trafficMapper.ts` | `mapTrafficToLinks:199-271` |
| BFS路径 | `llmDeployment/trafficMapper.ts` | `findShortestPath:60-94` |
| 延迟分析 | `llmDeployment/latencyEstimator.ts` | `analyzeLatency:336-407` |
| Prefill延迟 | `llmDeployment/latencyEstimator.ts` | `estimatePrefillComputeLatency:42-67` |
| Decode延迟 | `llmDeployment/latencyEstimator.ts` | `estimateDecodeComputeLatency:72-89` |
| 访存延迟 | `llmDeployment/latencyEstimator.ts` | `estimateDecodeMemoryLatency:129-149` |
| 通信延迟 | `llmDeployment/latencyEstimator.ts` | `estimatePrefillCommLatency:176-215` |
| 气泡比 | `llmDeployment/latencyEstimator.ts` | `calculatePPBubbleRatio:260-270` |
| 瓶颈识别 | `llmDeployment/latencyEstimator.ts` | `identifyBottleneck:290-327` |
| 综合评分 | `llmDeployment/planAnalyzer.ts` | `calculateOverallScore:218-256` |
| 方案分析 | `llmDeployment/planAnalyzer.ts` | `analyzePlan:343-407` |
| 拓扑提取 | `llmDeployment/topologyHardwareExtractor.ts` | `extractHardwareSummary:51-113` |
| 带宽提取 | `llmDeployment/topologyHardwareExtractor.ts` | `extractBandwidthFromConnections:118-165` |
| 模型预设 | `llmDeployment/presets.ts` | 全文件 |
| 显存计算 | `llmDeployment/modelCalculator.ts` | `analyzeMemory:243-267` |
| FLOPs计算 | `llmDeployment/modelCalculator.ts` | `calculatePrefillFlops:370-380` |

### 10.2 通信量计算

| 功能 | 文件 | 关键函数 |
|------|------|----------|
| TP通信量 | `llmDeployment/commCalculator.ts` | `calculateTPCommVolumePrefill/Decode` |
| PP通信量 | `llmDeployment/commCalculator.ts` | `calculatePPCommVolumePrefill/Decode` |
| EP通信量 | `llmDeployment/commCalculator.ts` | `calculateEPCommVolumePrefill/Decode` |
| SP通信量 | `llmDeployment/commCalculator.ts` | `calculateSPCommVolumePrefill/Decode` |
