# Tier6+ 互联建模系统 - 功能规划

> 规划日期: 2025-12-12
> 基于用户反馈优先级排序

## 一、功能需求汇总

根据用户反馈，确定以下功能方向：
1. **拓扑性能分析** - 计算拓扑理论指标
2. **流量/路由可视化** - 显示数据流向和路径
3. **故障模拟** - 模拟节点/链路故障
4. **多层级拓扑显示** - 同时显示多个层级的互联
5. **连接属性扩展** - 带宽、延迟等参数配置

---

## 二、功能模块详细设计

### 模块1: 多层级拓扑显示

#### 1.1 问题分析

**当前限制**：
- 每次只能看到单一层级的拓扑
- 无法直观理解跨层级数据流向
- 节点多时画面混乱

**用户需求**：
- 同时显示2个或多个层级
- 大量节点时有更好的显示方法

#### 1.2 解决方案

**方案A: 层级展开视图**

```
┌─────────────────────────────────────────────┐
│  Datacenter Layer                           │
│  ┌─────────┐    ┌─────────┐                │
│  │  Pod 0  │────│  Pod 1  │                │
│  └────┬────┘    └────┬────┘                │
│       │              │                      │
│═══════╪══════════════╪══════════════════════│ 层级分隔线
│       ▼              ▼                      │
│  Pod Layer (展开Pod 0)                      │
│  ┌──────┐  ┌──────┐  ┌──────┐              │
│  │Rack0 │──│Rack1 │──│Rack2 │              │
│  └──────┘  └──────┘  └──────┘              │
└─────────────────────────────────────────────┘
```

**实现要点**：
- 上层显示聚合视图，下层显示展开详情
- 用连接线表示层级间的父子关系
- 支持选择性展开（点击节点展开其子层级）

**方案B: 嵌套容器视图**

```
┌─────────────────────────────────────────────┐
│ Pod 0                                       │
│ ┌─────────┬─────────┬─────────┐            │
│ │ Rack 0  │ Rack 1  │ Rack 2  │            │
│ │ ┌─┬─┐   │ ┌─┬─┐   │ ┌─┬─┐   │            │
│ │ │B│B│   │ │B│B│   │ │B│B│   │ (Boards)   │
│ │ └─┴─┘   │ └─┴─┘   │ └─┴─┘   │            │
│ └─────────┴─────────┴─────────┘            │
│              ↕ Switch层                     │
│         [Leaf] [Leaf]                       │
│              ↕                              │
│           [Spine]                           │
└─────────────────────────────────────────────┘
```

**实现要点**：
- 父容器包含子节点
- 层级通过嵌套深度区分
- 可折叠/展开任意层级

**方案C: 节点聚合 + 按需展开**

```
正常视图:
┌────┐    ┌────┐    ┌────┐
│ 50 │────│ 50 │────│ 50 │   (聚合节点，显示数量)
└────┘    └────┘    └────┘

点击展开后:
┌────────────────────┐
│ ○○○○○○○○○○        │
│ ○○○○○○○○○○        │   (展开为实际节点)
│ ○○○○○○○○○○        │
│ ○○○○○○○○○○        │
│ ○○○○○○○○○○        │
└────────────────────┘
```

**实现要点**：
- 默认显示聚合视图（显示节点数量）
- 点击展开查看详细节点
- 支持局部展开（只展开感兴趣的部分）

#### 1.3 推荐方案

**结合方案A + C**：
1. 默认使用层级展开视图（方案A）
2. 节点数量>16时自动使用聚合显示（方案C）
3. 支持手动切换显示模式

#### 1.4 实现步骤

```
Phase 1: 基础多层级显示
├── 添加层级展开视图模式
├── 实现层级间连接线绘制
└── 添加展开/折叠控制

Phase 2: 节点聚合
├── 实现聚合节点组件
├── 添加展开/折叠交互
└── 聚合节点的连接处理

Phase 3: 优化与完善
├── 添加缩放级别的LOD
├── 性能优化（虚拟滚动）
└── 布局算法优化
```

---

### 模块2: 连接属性扩展

#### 2.1 当前连接模型

```typescript
// 现有
interface ConnectionConfig {
  source: string
  target: string
  type: string
  bandwidth?: number
}
```

#### 2.2 扩展连接模型

```typescript
// 扩展后
interface ConnectionConfig {
  source: string
  target: string
  type: string

  // 基本属性
  bandwidth: {
    value: number
    unit: 'Gbps' | 'Mbps' | 'Kbps'
  }
  latency: {
    value: number
    unit: 'ns' | 'us' | 'ms'
  }

  // 可选属性
  packetLossRate?: number      // 丢包率 (0-1)
  jitter?: number              // 抖动 (ns)
  errorRate?: number           // 误码率

  // 物理属性
  cableType?: 'copper' | 'fiber' | 'aoc'
  cableLength?: number         // 米

  // 状态
  status?: 'active' | 'inactive' | 'congested' | 'failed'
}
```

#### 2.3 UI设计

**连接配置面板**：
```
┌─────────────────────────────────────┐
│ 连接属性配置                         │
├─────────────────────────────────────┤
│ 带宽:    [___100___] [Gbps ▼]       │
│ 延迟:    [____10___] [ns   ▼]       │
│ 丢包率:  [___0.01__] %              │
│                                     │
│ ☑ 应用到同类型所有连接              │
│                                     │
│ [取消]              [确定]          │
└─────────────────────────────────────┘
```

**可视化映射**：
| 属性 | 可视化方式 |
|------|-----------|
| 带宽 | 线宽 + 颜色深度 |
| 延迟 | 虚线密度 |
| 状态 | 颜色 (绿/黄/红/灰) |

#### 2.4 实现步骤

```
Phase 1: 数据模型扩展
├── 扩展ConnectionConfig类型
├── 更新Pydantic模型
└── 迁移现有数据

Phase 2: 配置UI
├── 添加连接属性配置面板
├── 实现批量配置功能
└── 添加默认值模板

Phase 3: 可视化
├── 实现多属性可视化映射
├── 添加图例说明
└── 支持属性切换显示
```

---

### 模块3: 拓扑性能分析

#### 3.1 分析指标

**网络拓扑指标**：

| 指标 | 定义 | 计算方法 |
|------|------|----------|
| 直径 (Diameter) | 最长最短路径 | BFS遍历所有节点对 |
| 平均路径长度 | 所有节点对最短路径的平均 | Floyd-Warshall |
| 二分带宽 | 将网络分成两半的最小割带宽 | 最小割算法 |
| 连通度 | 移除多少节点/边后断开 | 连通性分析 |
| 平均度 | 节点平均连接数 | 简单统计 |

**成本指标**：

| 指标 | 计算方法 |
|------|----------|
| Switch数量 | 直接统计 |
| 端口总数 | 累加所有Switch端口 |
| 端口利用率 | 已用端口/总端口 |
| 线缆数量 | 连接数 |
| 估算成本 | Switch单价×数量 + 线缆单价×长度 |

#### 3.2 UI设计

**分析面板**：
```
┌─────────────────────────────────────────┐
│ 拓扑性能分析                            │
├─────────────────────────────────────────┤
│ 网络指标                                │
│ ├─ 直径:           4 跳                 │
│ ├─ 平均路径长度:   2.3 跳               │
│ ├─ 二分带宽:       800 Gbps             │
│ ├─ 节点连通度:     3                    │
│ └─ 边连通度:       4                    │
│                                         │
│ 成本估算                                │
│ ├─ Switch数量:     24                   │
│ ├─ 端口总数:       768                  │
│ ├─ 端口利用率:     62.5%               │
│ └─ 估算成本:       $XXX,XXX             │
│                                         │
│ [导出报告]  [与其他拓扑对比]            │
└─────────────────────────────────────────┘
```

**对比视图**：
```
┌──────────────────────────────────────────────────┐
│ 拓扑对比                                          │
├──────────────────────────────────────────────────┤
│                │ Fat-Tree │ Torus-3D │ DragonFly │
│ 直径           │    4     │    6     │    3      │
│ 平均路径长度   │   2.3    │   3.1    │   2.1     │
│ 二分带宽       │  800GB   │  400GB   │  600GB    │
│ Switch数量     │    24    │    0     │    8      │
│ 估算成本       │  $$$     │   $      │   $$      │
└──────────────────────────────────────────────────┘
```

#### 3.3 实现步骤

```
Phase 1: 计算引擎
├── 实现图算法（Dijkstra, Floyd-Warshall）
├── 实现拓扑指标计算
└── 添加成本计算模块

Phase 2: 前端展示
├── 添加分析面板组件
├── 实现图表展示
└── 添加对比功能

Phase 3: 报告导出
├── 生成PDF/Excel报告
└── 保存分析历史
```

---

### 模块4: 流量/路由可视化

#### 4.1 功能设计

**路由路径显示**：
- 选择源节点和目标节点
- 高亮显示路由路径
- 支持多路径显示（ECMP）

**流量热力图**：
- 根据链路带宽使用率着色
- 支持实时更新（仿真模式）
- 拥塞点高亮

**流量动画**：
- 数据包沿路径流动动画
- 可调节速度
- 暂停/播放控制

#### 4.2 UI设计

**路由查询面板**：
```
┌─────────────────────────────────────┐
│ 路由查询                            │
├─────────────────────────────────────┤
│ 源节点:   [Rack-0-Board-0  ▼]       │
│ 目标节点: [Rack-2-Board-1  ▼]       │
│                                     │
│ 路由算法: ○ 最短路径                │
│          ○ ECMP (显示所有路径)      │
│          ○ 自定义                   │
│                                     │
│ [显示路由]                          │
├─────────────────────────────────────┤
│ 路径信息:                           │
│ Path 1: B0 → S1 → S3 → B1 (3跳)    │
│ Path 2: B0 → S2 → S3 → B1 (3跳)    │
│ 总延迟: 150ns                       │
└─────────────────────────────────────┘
```

**热力图图例**：
```
链路负载
├─ 🟢 0-25%   空闲
├─ 🟡 25-50%  正常
├─ 🟠 50-75%  较忙
└─ 🔴 75-100% 拥塞
```

#### 4.3 实现步骤

```
Phase 1: 路由计算
├── 实现路由算法（最短路径、ECMP）
├── 添加路由查询API
└── 前端路由查询面板

Phase 2: 路径可视化
├── 实现路径高亮
├── 多路径同时显示
└── 路径信息展示

Phase 3: 热力图
├── 实现带宽使用率计算
├── 颜色映射系统
└── 图例和控制面板

Phase 4: 动画效果（可选）
├── 数据包流动动画
└── 播放控制
```

---

### 模块5: 故障模拟

#### 5.1 功能设计

**故障类型**：
- 节点故障（Switch/Rack/Board）
- 链路故障（单链路/批量）
- 部分降级（带宽降低）

**分析功能**：
- 故障影响范围分析
- 冗余路径验证
- 可达性矩阵更新

#### 5.2 UI设计

**故障模拟面板**：
```
┌─────────────────────────────────────┐
│ 故障模拟                            │
├─────────────────────────────────────┤
│ 故障类型: ○ 节点故障                │
│          ● 链路故障                 │
│          ○ 带宽降级                 │
│                                     │
│ 选择故障对象:                       │
│ ☑ Link: Rack0 ↔ Switch1            │
│ ☐ Link: Rack1 ↔ Switch1            │
│ ☐ Link: Switch1 ↔ Switch2          │
│                                     │
│ [模拟故障]  [恢复]  [随机故障]      │
├─────────────────────────────────────┤
│ 影响分析:                           │
│ ├─ 受影响节点: 8                    │
│ ├─ 断开连接: 0 (有冗余路径)         │
│ └─ 带宽下降: 50%                    │
└─────────────────────────────────────┘
```

#### 5.3 实现步骤

```
Phase 1: 故障模型
├── 实现故障状态管理
├── 添加故障注入API
└── 拓扑图故障显示（灰色/删除线）

Phase 2: 影响分析
├── 实现可达性分析
├── 冗余路径计算
└── 影响范围可视化

Phase 3: 交互优化
├── 点击选择故障节点/链路
├── 随机故障生成
└── 故障场景保存/加载
```

---

## 三、实现优先级

### 高优先级 (Phase 1)

| 功能 | 原因 | 工作量 |
|------|------|--------|
| 连接属性扩展 | 基础功能，影响后续模块 | 中 |
| 多层级显示(基础) | 用户强需求 | 大 |
| 拓扑性能分析 | 用户需求 | 中 |

### 中优先级 (Phase 2)

| 功能 | 原因 | 工作量 |
|------|------|--------|
| 路由可视化 | 依赖连接属性 | 中 |
| 节点聚合 | 改善大规模显示 | 中 |
| 故障模拟(基础) | 用户需求 | 中 |

### 低优先级 (Phase 3)

| 功能 | 原因 | 工作量 |
|------|------|--------|
| 流量热力图 | 依赖仿真集成 | 大 |
| 流量动画 | 锦上添花 | 中 |
| 故障场景管理 | 高级功能 | 小 |

---

## 四、技术方案选型

### 4.1 图算法库

**推荐**: 前端使用 Cytoscape.js 内置算法，复杂计算后端用 NetworkX

### 4.2 可视化方案

**推荐**: 继续使用 Cytoscape.js，扩展样式映射

### 4.3 数据流

```
用户操作 → 前端状态 → API请求 → 后端计算 → 返回结果 → 可视化更新
```

---

## 五、文件修改清单

### 前端

| 文件 | 修改内容 |
|------|----------|
| types.ts | 扩展ConnectionConfig类型 |
| TopologyGraph.tsx | 多层级显示、聚合节点、路由高亮 |
| ConfigPanel.tsx | 连接属性配置面板 |
| 新增: AnalysisPanel.tsx | 拓扑分析面板 |
| 新增: FaultSimPanel.tsx | 故障模拟面板 |
| 新增: RouteQueryPanel.tsx | 路由查询面板 |

### 后端

| 文件 | 修改内容 |
|------|----------|
| models.py | 扩展连接模型 |
| topology.py | 添加分析计算函数 |
| 新增: analysis.py | 拓扑分析引擎 |
| 新增: routing.py | 路由计算引擎 |
| main.py | 添加新API端点 |

---

## 六、API设计

### 新增API

```
# 拓扑分析
GET  /api/analysis/metrics              # 获取拓扑指标
GET  /api/analysis/compare              # 对比多个拓扑

# 路由查询
POST /api/routing/path                  # 查询路由路径
GET  /api/routing/reachability          # 可达性矩阵

# 故障模拟
POST /api/fault/inject                  # 注入故障
POST /api/fault/recover                 # 恢复故障
GET  /api/fault/impact                  # 故障影响分析
```

---

## 七、里程碑规划

### M1: 基础增强
- [ ] 连接属性扩展（带宽、延迟）
- [ ] 连接属性配置UI
- [ ] 拓扑性能指标计算
- [ ] 分析结果展示

### M2: 可视化增强
- [ ] 多层级显示（基础版）
- [ ] 路由查询和高亮
- [ ] 节点聚合显示

### M3: 高级功能
- [ ] 故障模拟
- [ ] 流量热力图
- [ ] 拓扑对比
- [ ] 报告导出
