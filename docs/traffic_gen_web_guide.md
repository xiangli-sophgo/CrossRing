# CrossRing 流量生成Web工具使用指南

## 快速开始

### 1. 安装依赖

```bash
cd C:\Users\xiang\Documents\code\CrossRing
pip install -r requirements.txt
```

### 2. 启动应用

```bash
streamlit run scripts/tools/traffic_gen_web.py
```

应用将在浏览器中自动打开,默认地址: http://localhost:8501

---

## 功能说明

### 1. 拓扑可视化

- **拓扑类型选择**: 支持5x4和4x4拓扑
- **节点可视化**:
  - 彩色方块表示不同IP类型(GDMA/DDR/L2M/SDMA/CDMA)
  - 节点上显示节点ID和IP类型
- **交互式选择**:
  - 选择"选择源节点"模式,点击拓扑图上的节点选择源节点
  - 选择"选择目标节点"模式,点击拓扑图上的节点选择目标节点
  - 源节点显示为天蓝色,目标节点显示为粉色
  - 再次点击可取消选择

### 2. 配置管理

#### 配置表单

- **源IP类型**: 源节点的IP类型标识(如`gdma_0`)
- **目标IP类型**: 目标节点的IP类型标识(如`ddr_0`)
- **带宽**: 流量带宽 (0.1 - 128.0 GB/s)
- **Burst长度**: 突发长度 (1/2/4/8/16)
- **请求类型**: 读(R) 或 写(W)

#### 添加配置

1. 在拓扑图上选择源节点和目标节点
2. 填写配置参数
3. 点击"➕ 添加配置"
4. 配置将添加到配置列表

#### 管理配置

- **查看配置**: 展开配置列表中的配置项查看详情
- **删除配置**: 点击配置项右侧的"🗑️ 删除"按钮

### 3. 预估统计

在添加配置后,系统会自动计算预估统计:

- **预计总请求数**: 所有配置产生的总请求数
- **读请求数**: 读请求总数
- **写请求数**: 写请求总数
- **配置数**: 当前配置数量

### 4. 生成流量文件

#### 生成步骤

1. 确保至少添加了一个配置
2. 设置输出文件名(默认自动生成带时间戳的文件名)
3. 在侧边栏设置仿真时长(默认6000ns)
4. 点击"🚀 生成流量文件"

#### 输出文件

- **保存位置**: `traffic/` 目录
- **文件格式**: CSV文本文件,每行一条流量记录
- **字段说明**:
  - timestamp: 时间戳 (ns)
  - src_pos: 源节点物理ID
  - src_type: 源IP类型
  - dst_pos: 目标节点物理ID
  - dst_type: 目标IP类型
  - req_type: 请求类型 (R/W)
  - burst: burst长度

#### 下载文件

生成成功后,点击"📥 下载流量文件"按钮可直接下载到本地

### 5. 结果分析

生成流量后,系统会自动展示分析结果:

#### 统计摘要表

显示关键统计指标:
- 总请求数
- 读/写请求数及占比
- 时间范围
- 涉及节点数
- 平均Burst长度等

#### 可视化图表

**时间序列**: 展示请求随时间的分布趋势

**读写分布**: 饼图显示读写请求比例

**热力图**: 节点间流量强度热力图,颜色深度表示流量大小

**数据预览**: 前100条流量记录的详细数据表格

---

## 使用示例

### 示例1: 简单读流量(GDMA → DDR)

1. 选择拓扑类型: 5x4
2. 点击模式: "选择源节点"
3. 在拓扑图上点击节点6, 7(GDMA节点)
4. 切换到"选择目标节点"模式
5. 点击节点12, 13(DDR节点)
6. 填写配置:
   - 源IP类型: `gdma_0`
   - 目标IP类型: `ddr_0`
   - 带宽: 46.08 GB/s
   - Burst: 4
   - 请求类型: R
7. 点击"➕ 添加配置"
8. 设置仿真时长: 6000 ns
9. 点击"🚀 生成流量文件"

### 示例2: 混合读写流量

1. 添加第一个配置(读):
   - 源: GDMA节点 [6, 7]
   - 目标: DDR节点 [12, 13]
   - 带宽: 46.08 GB/s, Burst: 4, 类型: R

2. 添加第二个配置(写):
   - 源: SDMA节点 [0, 1]
   - 目标: L2M节点 [18, 19]
   - 带宽: 30.0 GB/s, Burst: 8, 类型: W

3. 生成流量文件

---

## 注意事项

### 配置验证

系统会自动验证配置的合法性:

- ❌ **源/目标节点不能为空**
- ❌ **节点ID必须在范围内** (0 ~ 节点总数-1)
- ❌ **带宽必须大于0且不超过总带宽**
- ❌ **Burst长度应为2的幂次** (1/2/4/8/16)
- ❌ **请求类型必须是R或W**

### 性能建议

- **仿真时长**: 建议不超过100000ns,避免生成过大文件
- **配置数量**: 单次生成建议不超过10个配置
- **节点选择**: 大量节点时使用热力图功能可能较慢

### 常见问题

**Q: 点击拓扑图节点没有反应?**

A: 请确保已选择正确的点击模式("选择源节点"或"选择目标节点")

**Q: 添加配置时提示验证失败?**

A: 检查是否已选择源/目标节点,以及参数是否在合法范围内

**Q: 生成的流量文件在哪里?**

A: 文件保存在项目的`traffic/`目录下,也可点击下载按钮直接下载

**Q: 如何清空所有配置重新开始?**

A: 逐个删除配置,或刷新页面(会清空所有状态)

---

## 技术架构

### 文件结构

```
src/traffic_process/web_modules/
├── __init__.py                  # 模块初始化
├── generation_engine.py         # 流量生成引擎
├── topology_visualizer.py       # 拓扑可视化
├── config_manager.py            # 配置管理
└── traffic_analyzer.py          # 流量分析

scripts/tools/
└── traffic_gen_web.py           # Streamlit主程序
```

### 核心模块

- **TopologyVisualizer**: 基于Plotly的交互式拓扑网格绘制
- **ConfigManager**: 配置验证、管理和预估统计
- **TrafficAnalyzer**: 流量数据解析和可视化分析
- **generation_engine**: 封装generate_data.py的流量生成逻辑

---

## 后续扩展

### 计划功能 (MVP后)

- [ ] D2D多Die流量支持
- [ ] 配置模板功能(预设常用流量模式)
- [ ] 配置导入/导出(JSON格式)
- [ ] 批量生成多个场景
- [ ] 流量回放动画

---

## 反馈与支持

如遇到问题或有功能建议,请联系开发团队。

**版本**: v1.0.0 (MVP)
**更新日期**: 2025-11-18
